---
title: "report"
author: "Nathan Faber and Thomas Jagielski"
date: 2020-11-27
output:
  github_document:
    toc: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(haven)
library(dplyr)
library(broom)
library(ggcorrplot)
library(corrplot)
library(modelr)

logit <- function(p) {
  odds_ratio <- p / (1 - p)
  log(odds_ratio)
}

inv.logit <- function(x) {
  exp(x) / (1 + exp(x))
}
```

## How Couples Meet and If They Stay Together

### Question
Are there predicting factors for if a couple are more likely to stay together or split up?  If so, can we model the likelihood of a couple staying together or splitting up based on inputs for the predicting factors?

### Dataset and Background
This project utilizes the HCMST (How Couples Meet and Stay Together) [https://data.stanford.edu/hcmst2017] This dataset was collected in 2017 and is made up of ~4,000 survey results from individuals 18+ that had been in a relationship previously. This survey is a remake of an earlier version of this survey with similar data. The data  contains a wide range of variables--all pertaining to the individual and their partner. Some examples of the data available include: Race, Religion, Level of Education, Sexual Orientation, How their relationship ended etc.

The survey  does have several notable quirks. The survey separates out an LGB group that was specifically sampled for. The survey was orchestrated through a rewards platform (KnowledgeBase) in which participants were compensated. This could introduce some form of sample bias. There were specific measures taken to attempt to get a representative sample, for example, random dialing of telephone numbers, as well as using address based sampling.

Given the above, this data source suits our purposes and will aid us in understanding which factors cause couples to stay together.

### Correlation Matrix for Predictive Factors
```{r load_data}
df_raw <- read_dta(file = "./data/HCMST.dta")

df_column_rename <-
  df_raw %>%
    as.tibble() %>%
    rename(
      married = S1,
      current_partner_status = S2,
      ever_had_partner = S3,
      partner_sex = Q4,
      partner_same_sex = Q5,
      partner_latino_hispanic = Q6A,
      partner_race = Q6B,
      partner_age = Q9,
      partner_education_level = Q10,
      partner_mother_education_level = Q11,
      partner_polictial_belief = Q12,
      your_mother_education_level = Q14,
      #country_you_grew_up_in = Q15A1,
      #state_you_grew_up_in = Q15A2,
      #city_you_grew_up_in = Q15A3,
      #your_country_met_partner = Q15A4,
      #your_state_met_partner = Q15A5,
      #your_city_met_partner = Q15A6,
      met_partner_location = Q15A7,
      number_relatives_you_visit = Q16,
      times_married_inclusive = Q17A, # if S1=1
      times_married = Q17B, # if S1=2
      gender_sexually_attracted_to_1 = Q17C, # ppgender = 2
      gender_sexually_attracted_to_2 = Q17D, #ppgender = 1
      currently_living_with_partner = Q19,
      ever_lived_together_w_partner = Q20,
      date_met_year = Q21A_Year,
      date_met_month = Q21A_Month,
      date_relationship_began_year = Q21B_Year,
      date_relationship_began_month = Q21B_Month,
      date_first_lived_together_year = Q21C_Year,
      date_first_lived_together_month = Q21C_Month,
      date_married_year = Q21D_Year,
      date_married_month = Q21D_Month,
      sexual_orientation = w6_identity,
      outness = w6_outness,
      age_came_out = w6_outness_timing,
      income_disparity = Q23,
      #story_how_met = Q24,
      same_high_school = Q25,
      same_university = Q26,
      grow_up_same_town = Q27,
      parents_knew_each_other_before_met = Q28,
      mutual_friends_prior_1 = w6_friend_connect_1,
      mutual_friends_prior_2 = w6_friend_connect_2,
      mutual_friends_prior_3 = w6_friend_connect_3,
      mutual_friends_prior_4 = w6_friend_connect_4,
      met_online = Q32,
      relationship_quality = Q34,
      #realtionship_explaination = Q35,
      sex_frequency = w6_sex_frequency,
      other_date = w6_otherdate,
      number_others_dated = w6_how_many, # how many other people met with besides partner
      #how_met = w6_how_meet,
      dating_app_met_other = w6_otherdate_app,
      how_many_met_dating_app = w6_how_many_app,
      #most_commonly_used_dating_app = Q40,
      ever_married_to_partner = Past_Partner_Q1,
      relationship_end_nonmar = w6_relationship_end_nonmar,
      who_wanted_breakup_more_nonmar = w6_breakup_nonmar,
      marriage_end_mar = w6_relationship_end_mar,
      who_broke_up = w6_who_breakup,
      #reason_break_up = w6_why_broke_up,
      partner_same_sex_2 = Q5_2,
      partner_hispanic_latino_2 = Q6A_2,
      year_partner_born_2 = Q9B_2,
      partner_education_level_2 = Q10_2,
      partner_mother_education_level_2 = Q11_2,
      partner_polictial_belief_2 = Q12_2,
      your_mother_education_level_2 = Q14_2,
      #country_you_grew_up_in_2 = Q15A1_2,
      #state_you_grew_up_in_2 = Q15A2_2,
      #city_you_grew_up_in_2 = Q15A3_2,
      #your_country_met_partner_2 = Q15A4_2,
      #your_state_met_partner_2 = Q15A5_2,
      #your_city_met_partner_2 = Q15A6_2,
      met_partner_location_2 = Q15A7_2_1,
      number_relatives_you_visit_2 = Q16_2,
      times_married_2 = Q17B_2,
      gender_sexually_attracted_to_1_2 = Q17C_2, # ppgender = 2
      gender_sexually_attracted_to_2_2 = Q17D_2, #ppgender = 1
      ever_lived_together_w_partner_2 = Q20_2,
      date_met_year_2 = Q21A_2_Year,
      date_met_month_2 = Q21A_2_Month,
      date_relationship_began_year_2 = Q21B_2_Year,
      date_relationship_began_month_2 = Q21B_2_Month,
      date_first_lived_together_year_2 = Q21C_2_Year,
      date_first_lived_together_month_2 = Q21C_2_Month,
      date_married_year_2 = Q21D_2_Year,
      date_married_month_2 = Q21D_2_Month,
      date_broken_up_year_2 = Q21E_2_Year,
      date_broken_up_month_2 = Q21E_2_Month,
      date_partner_pass_year = Q21F_2_Year,
      date_partner_pass_month = Q21F_2_Month,
      sexual_orientation_2 = w6_identity_2,
      outness_2 = w6_outness_2,
      age_came_out_2 = w6_outness_timing_2,
      income_disparity_2 = Q23_2,
      #story_how_met_2 = Q24_2,
      same_high_school_2 = Q25_2,
      same_university_2 = Q26_2,
      grow_up_same_town_2 = Q27_2,
      parents_knew_each_other_before_met_2 = Q28_2,
      mutual_friends_prior_1_2 = w6_friend_connect_2_1,
      mutual_friends_prior_2_2 = w6_friend_connect_2_2,
      mutual_friends_prior_3_2 = w6_friend_connect_2_3,
      mutual_friends_prior_4_2 = w6_friend_connect_2_4,
      met_online_2 = Q32_2,
      other_date_2 = w6_otherdate_2,      
      number_others_dated_2 = w6_how_many_2, # how many other people met with besides partner
      dating_app_met_other_2 = w6_otherdate_app_2,
      how_many_met_dating_app_2 = w6_how_many_app_2      
      )
```


### Modelling

```{r}
model_married <-
  glm(
    formula = married ~ relationship_quality + age_when_met,
    data = df_data %>%
      mutate(relationship_quality = as.numeric(relationship_quality),
             age_when_met = as.numeric(age_when_met)) %>%
      filter(
        !is.na(relationship_quality) &
        !is.na(age_when_met) &
        !is.na(married)),
    family = "binomial"
  ) %>% 
    tidy(
    conf.int = TRUE,
    conf.level = 0.90
  ) %>% mutate(
    mse = mse_val,
    rsquare = rsquare_val
  )

model_married
```


```{r}
data <-
  df_of_interest %>%
    mutate(across(everything(), as_factor)) %>%
    mutate(married = as.numeric(married),
           relationship_quality = as.numeric(relationship_quality),
           age_when_met = as.numeric(age_when_met),
           marriage_end_mar = as.numeric(marriage_end_mar),
           met_online = as.numeric(met_online),
           partner_polictial_belief = as.numeric(partner_polictial_belief),
           partyid7 = as.numeric(partyid7),
           political_diff = abs(partner_polictial_belief - partyid7),
           grow_up_same_town = as.numeric(grow_up_same_town),
           ever_had_partner = as.numeric(ever_had_partner),
           other_date = as.numeric(other_date),
           same_high_school = as.numeric(same_high_school),
           same_university = as.numeric(same_university),
           sexual_orientation = as.numeric(sexual_orientation),
           ever_lived_together_w_partner = as.numeric(ever_lived_together_w_partner),
           xlgb = as.numeric(xlgb))

data$partner_polictial_belief

data[ ,c("married", 
         "relationship_quality",
         "age_when_met",
         "marriage_end_mar",
         "met_online",
         "political_diff",
         "grow_up_same_town",
         "ever_had_partner",
         "other_date",
         "same_high_school",
         "same_university",
         "sexual_orientation",
         "ever_lived_together_w_partner",
         "xlgb")] %>%
  cor(use="pairwise.complete.obs", method = c("pearson", "kendall", "spearman")) %>%
  round(5) %>%
  ggcorrplot(show.diag = T, type = "full", lab = TRUE, lab_size = 2) +
  ggtitle("Correlation Matrix for Broken Up Couples")

#tbl_vars(df_of_interest)
#df_of_interest %>%
#  mutate(across(everything(), as_factor))

df_of_interest %>%
  select(met_online) %>%
  summarize(numeric = as.numeric(met_online) - 1, met_online)

df_data
```

```{r}
model_married <-
  glm(
    formula = married ~ relationship_quality + age_when_met + met_online,
    data = df_data %>%
      mutate(relationship_quality = as.numeric(relationship_quality),
             age_when_met = as.numeric(age_when_met),
             met_online = as.numeric(met_online)) %>%
      filter(
        !is.na(relationship_quality) &
        !is.na(age_when_met) &
        !is.na(married) &
        !is.na(met_online)),
    family = "binomial"
  )


data_test <- tibble(relationship_quality = 2, age_when_met = 15, met_online = 1)
df_basic <-
  data_test %>%
  add_predictions(model_married, var = "log_odds_ratio") %>%
  arrange(log_odds_ratio) %>%
  rowid_to_column(var = "order") %>%
  mutate(pr_married = inv.logit(log_odds_ratio))

df_basic
```

### Remaining Questions