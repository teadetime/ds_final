---
title: "HCSMT"
output: html_document
---

Data from: https://data.stanford.edu/hcmst2017#download-data

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(haven)
library(dplyr)
library(broom)
library(ggcorrplot)
library(corrplot)


add_uncertainties <- function(data, model, prefix = "pred", ...) {
  df_fit <-
    stats::predict(model, data, ...) %>%
    as_tibble() %>%
    rename_with(~ str_c(prefix, "_", .))

  bind_cols(data, df_fit)
}
```

## R Markdown

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document. You can embed an R code chunk like this:

```{r cars}
df_raw <- read_dta(file = "./data/HCMST.dta")
df_raw %>% summary()
df_raw %>% head()
```
```{r question_relabel}
#df_raw %>%
#  colnames()

df_column_rename <-
  df_raw %>%
    as.tibble() %>%
    rename(
      married = S1,
      current_partner_status = S2,
      ever_had_partner = S3,
      partner_sex = Q4,
      partner_same_sex = Q5,
      partner_latino_hispanic = Q6A,
      partner_race = Q6B,
      partner_age = Q9,
      partner_education_level = Q10,
      partner_mother_education_level = Q11,
      partner_polictial_belief = Q12,
      your_mother_education_level = Q14,
      #country_you_grew_up_in = Q15A1,
      #state_you_grew_up_in = Q15A2,
      #city_you_grew_up_in = Q15A3,
      #your_country_met_partner = Q15A4,
      #your_state_met_partner = Q15A5,
      #your_city_met_partner = Q15A6,
      met_partner_location = Q15A7,
      number_relatives_you_visit = Q16,
      times_married_inclusive = Q17A, # if S1=1
      times_married = Q17B, # if S1=2
      gender_sexually_attracted_to_1 = Q17C, # ppgender = 2
      gender_sexually_attracted_to_2 = Q17D, #ppgender = 1
      currently_living_with_partner = Q19,
      ever_lived_together_w_partner = Q20,
      date_met_year = Q21A_Year,
      date_met_month = Q21A_Month,
      date_relationship_began_year = Q21B_Year,
      date_relationship_began_month = Q21B_Month,
      date_first_lived_together_year = Q21C_Year,
      date_first_lived_together_month = Q21C_Month,
      date_married_year = Q21D_Year,
      date_married_month = Q21D_Month,
      sexual_orientation = w6_identity,
      outness = w6_outness,
      age_came_out = w6_outness_timing,
      income_disparity = Q23,
      #story_how_met = Q24,
      same_high_school = Q25,
      same_university = Q26,
      grow_up_same_town = Q27,
      parents_knew_each_other_before_met = Q28,
      mutual_friends_prior_1 = w6_friend_connect_1,
      mutual_friends_prior_2 = w6_friend_connect_2,
      mutual_friends_prior_3 = w6_friend_connect_3,
      mutual_friends_prior_4 = w6_friend_connect_4,
      met_online = Q32,
      relationship_quality = Q34,
      #realtionship_explaination = Q35,
      sex_frequency = w6_sex_frequency,
      other_date = w6_otherdate,
      number_others_dated = w6_how_many, # how many other people met with besides partner
      #how_met = w6_how_meet,
      dating_app_met_other = w6_otherdate_app,
      how_many_met_dating_app = w6_how_many_app,
      #most_commonly_used_dating_app = Q40,
      ever_married_to_partner = Past_Partner_Q1,
      relationship_end_nonmar = w6_relationship_end_nonmar,
      who_wanted_breakup_more_nonmar = w6_breakup_nonmar,
      marriage_end_mar = w6_relationship_end_mar,
      who_broke_up = w6_who_breakup,
      #reason_break_up = w6_why_broke_up,
      partner_same_sex_2 = Q5_2,
      partner_hispanic_latino_2 = Q6A_2,
      year_partner_born_2 = Q9B_2,
      partner_education_level_2 = Q10_2,
      partner_mother_education_level_2 = Q11_2,
      partner_polictial_belief_2 = Q12_2,
      your_mother_education_level_2 = Q14_2,
      #country_you_grew_up_in_2 = Q15A1_2,
      #state_you_grew_up_in_2 = Q15A2_2,
      #city_you_grew_up_in_2 = Q15A3_2,
      #your_country_met_partner_2 = Q15A4_2,
      #your_state_met_partner_2 = Q15A5_2,
      #your_city_met_partner_2 = Q15A6_2,
      met_partner_location_2 = Q15A7_2_1,
      number_relatives_you_visit_2 = Q16_2,
      times_married_2 = Q17B_2,
      gender_sexually_attracted_to_1_2 = Q17C_2, # ppgender = 2
      gender_sexually_attracted_to_2_2 = Q17D_2, #ppgender = 1
      ever_lived_together_w_partner_2 = Q20_2,
      date_met_year_2 = Q21A_2_Year,
      date_met_month_2 = Q21A_2_Month,
      date_relationship_began_year_2 = Q21B_2_Year,
      date_relationship_began_month_2 = Q21B_2_Month,
      date_first_lived_together_year_2 = Q21C_2_Year,
      date_first_lived_together_month_2 = Q21C_2_Month,
      date_married_year_2 = Q21D_2_Year,
      date_married_month_2 = Q21D_2_Month,
      date_broken_up_year_2 = Q21E_2_Year,
      date_broken_up_month_2 = Q21E_2_Month,
      date_partner_pass_year = Q21F_2_Year,
      date_partner_pass_month = Q21F_2_Month,
      sexual_orientation_2 = w6_identity_2,
      outness_2 = w6_outness_2,
      age_came_out_2 = w6_outness_timing_2,
      income_disparity_2 = Q23_2,
      #story_how_met_2 = Q24_2,
      same_high_school_2 = Q25_2,
      same_university_2 = Q26_2,
      grow_up_same_town_2 = Q27_2,
      parents_knew_each_other_before_met_2 = Q28_2,
      mutual_friends_prior_1_2 = w6_friend_connect_2_1,
      mutual_friends_prior_2_2 = w6_friend_connect_2_2,
      mutual_friends_prior_3_2 = w6_friend_connect_2_3,
      mutual_friends_prior_4_2 = w6_friend_connect_2_4,
      met_online_2 = Q32_2,
      other_date_2 = w6_otherdate_2,      
      number_others_dated_2 = w6_how_many_2, # how many other people met with besides partner
      dating_app_met_other_2 = w6_otherdate_app_2,
      how_many_met_dating_app_2 = w6_how_many_app_2      
      )
```

```{r}
df_data <-
  df_column_rename %>%
    mutate(across(everything(), as_factor))

df_data
```

```{r}
number_of_rows <-
  df_data %>%
    summarize(N = n())

number_match <- 
  df_data %>%
      filter(as.character(tolower(partyid7)) == as.character(tolower(partner_polictial_belief))) %>%
      summarize(N = n())

number_match / number_of_rows
```


```{r}
number_of_rows <-
  df_data %>%
    summarize(N = n())
number_match <- 
  df_data %>%
      filter(as.character(tolower(partner_education_level)) == as.character(tolower(ppeduc))) %>%
      summarize(N = n())

number_match / number_of_rows
```


```{r}
df_filtered <- df_data 
# as.logical(!is.na(str_extract(df_filtered$married, "^Yes")))
df_filtered$married <- ifelse(is.na(df_filtered$married) | df_filtered$married == "Refused" ,
                              NA,
                              as.logical(!is.na(str_extract(df_filtered$married, "^Yes"))))


df_filtered$ever_had_partner <- ifelse(is.na(df_filtered$ever_had_partner) | df_filtered$ever_had_partner == "Refused" ,
                              NA,
                              as.logical(!is.na(str_extract(df_filtered$ever_had_partner, "^Yes"))))

#df_filtered$current_partner_status_simplified <- ifelse(is.na(df_filtered$current_partner_status) | df_filtered$ever_had_partner == "Refused",
#                                             NA,
#                                             as.logical(!is.na(str_extract(df_filtered$current_partner_status, "^Yes"))))

df_filtered$partner_same_sex <- ifelse(is.na(df_filtered$partner_same_sex) | df_filtered$partner_same_sex == "Refused",
                                             NA,
                                             as.logical(!is.na(str_extract(df_filtered$partner_same_sex, "^Yes"))))

# Encode Partner Sex as True for male and false for female
df_filtered$partner_sex <- ifelse(is.na(df_filtered$partner_sex) | df_filtered$partner_sex == "Refused",
                                              NA,
                                              as.logical(!is.na(str_extract(df_filtered$partner_sex, "Male$"))))

df_filtered$same_high_school <- ifelse(is.na(df_filtered$same_high_school) | df_filtered$same_high_school== "Refused",
                                              NA,
                                              as.logical(!is.na(str_extract(df_filtered$same_high_school, "^Same"))))


df_filtered$same_university <- ifelse(is.na(df_filtered$same_university) | df_filtered$same_university== "Refused",
                                              NA,
                                              as.logical(!is.na(str_extract(df_filtered$same_university, "^Atten"))))

df_filtered$parents_knew_each_other_before_met<- ifelse(is.na(df_filtered$parents_knew_each_other_before_met) | df_filtered$parents_knew_each_other_before_met == "Refused",
                                             NA,
                                             as.logical(!is.na(str_extract(df_filtered$parents_knew_each_other_before_met, "^Yes"))))

df_filtered$grow_up_same_town <- ifelse(is.na(df_filtered$grow_up_same_town) | df_filtered$grow_up_same_town == "Refused",
                                             NA,
                                             as.logical(!is.na(str_extract(df_filtered$grow_up_same_town, "^Yes"))))

df_filtered$other_date <- ifelse(is.na(df_filtered$other_date) | df_filtered$other_date == "Refused",
                                             NA,
                                             as.logical(!is.na(str_extract(df_filtered$other_date, "^Yes"))))
df_filtered
# df_data %>% 
#   summarize(cnt_na = sum(is.na(ever_had_partner)),cnt_ref = sum(ever_had_partner == "Refused", na.rm = TRUE), cnt_yes = sum(ever_had_partner == "Yes", na.rm = TRUE),  cnt_no = sum(ever_had_partner == "No", na.rm = TRUE), cnt=n())
# 

```

```{r}
df_filtered %>%
  sample_n(10) %>%
  filter(!is.na(married)) %>%
  ggplot() + 
  geom_point(mapping = aes(x = CaseID, y = current_partner_status))


df_filtered %>% 
  filter(current_partner_status == "No, I am single, with no boyfriend, no girlfriend and no romantic or sexual partner")

```




```{r}
number_of_rows <-
  df_data %>%
    filter(!is.na(who_wanted_breakup_more_nonmar) & (ppgender == 'Male')) %>%
    summarize(N = n())

number_of_males <-
  df_data %>%
    filter(!is.na(who_wanted_breakup_more_nonmar) & (ppgender == 'Male')) %>%
    summarize(N = n())

number_of_females <-
  df_data %>%
    filter(!is.na(who_wanted_breakup_more_nonmar) & (ppgender == 'Female')) %>%
    summarize(N = n())

males_want_break_up <- 
  df_data %>%
      #filter((who_wanted_breakup_more_nonmar == "I wanted to break up more") & (ppgender == 'Male')) %>%
      #filter((who_wanted_breakup_more_nonmar == "[Partner Name] wanted to break up more") & (ppgender == 'Male')) %>%
      filter((who_wanted_breakup_more_nonmar == "We both equally wanted to break up") & (ppgender == 'Male')) %>%      
      summarize(N = n())


females_want_break_up <- 
  df_data %>%
      #filter((who_wanted_breakup_more_nonmar == "I wanted to break up more") & (ppgender == 'Female')) %>%
      #filter((who_wanted_breakup_more_nonmar == "[Partner Name] wanted to break up more") & (ppgender == 'Female')) %>%  
      filter((who_wanted_breakup_more_nonmar == "We both equally wanted to break up") & (ppgender == 'Female')) %>%  
      summarize(N = n())

females_want_break_up

males_want_break_up / number_of_males
females_want_break_up / number_of_females

```

```{r}
numeric_political <-
  df_data %>%
    filter((!is.na(partyid7)) & (!is.na(partner_polictial_belief))) %>%
    mutate(partner_polictial_belief = as.numeric(partner_polictial_belief) - 1,
           partyid7 = as.numeric(partyid7) - 1) #%>%
    #summarise(partyid7, partner_polictial_belief)


number_match <- 
  numeric_political %>%
    mutate(political_diff = abs(partyid7 - partner_polictial_belief)) %>%
    summarise(mean(political_diff))
    #filter((political_diff > 2)) #& (relationship_end_nonmar == "We broke up")) #%>%
    #summarize(N = n())

number_match

numeric_political

#relationship_end_nonmar == "We broke up"
```


```{r}
df_data %>%
  filter(!is.na(relationship_quality)) %>%
  mutate(relationship_quality = as.numeric(relationship_quality) - 1) %>%
  #filter(married == "Yes, I am Married") %>%
  filter(married == "No, I am not Married") %>%
  summarize(mean(relationship_quality))


#levels(df_data$relationship_end_nonmar)
```


```{r}
convert_hcm2017q24_college <- function(x) {
  mutate(x = as.numeric(x)) %>%
  case_when(
    x == 0 ~ 1,
    x == 1 ~ 0,
    TRUE ~ NA_integer_
  )
}
```

```{r}
data <-
  df_data %>%
    filter(!is.na(relationship_quality) & 
             !is.na(married) & 
             !is.na(partyid7) & 
             !is.na(partner_polictial_belief) & 
             !is.na(currently_living_with_partner) &
             !is.na(date_relationship_began_month) &
             !is.na(grow_up_same_town) &
             !is.na(met_online) &
             !is.na(sex_frequency) &
             !is.na(income_disparity) &
             !is.na(same_university) &
             !is.na(partner_education_level) &
             !is.na(ppeduc) &
             !is.na(age_when_met) &
             !is.na(hcm2017q24_college)) %>%
  
    mutate(relationship_quality = as.numeric(relationship_quality) - 1,
           married = as.numeric(married) - 1,
           partner_polictial_belief = as.numeric(partner_polictial_belief) - 1,
           partyid7 = as.numeric(partyid7) - 1,
           political_diff = abs(partyid7 - partner_polictial_belief),
           currently_living_with_partner = as.numeric(currently_living_with_partner) - 1,
           date_relationship_began_month = as.numeric(date_relationship_began_month) - 1,
           grow_up_same_town = as.numeric(grow_up_same_town) - 1,
           met_online = as.numeric(met_online) - 1,
           sex_frequency = as.numeric(sex_frequency) - 1,
           income_disparity = as.numeric(income_disparity) - 1,
           same_university = as.numeric(same_university) - 1,
           partner_education_level = as.numeric(partner_education_level) - 1,
           ppeduc = as.numeric(ppeduc) - 1,
           edu_diff = abs(partner_education_level - ppeduc),
           age_when_met = as.numeric(age_when_met) - 1,
           hcm2017q24_college = as.numeric(hcm2017q24_college) - 1)

data[ ,c("relationship_quality", 
         "married", 
         "political_diff", 
         "currently_living_with_partner",
         "date_relationship_began_month",
         "grow_up_same_town",
         "met_online",
         "sex_frequency",
         "income_disparity",
         "same_university",
         "edu_diff",
         "age_when_met",
         "hcm2017q24_college")] %>%
  cor(method = c("pearson", "kendall", "spearman")) %>%
  round(5) %>%
  ggcorrplot(show.diag = T, type = "full", lab = TRUE, lab_size = 2) +
  ggtitle("Correlation Matrix for Married Couples")
```


```{r}
data <-
  df_data %>%
    filter(#!is.na(relationship_quality) & 
             !is.na(marriage_end_mar) &
             !is.na(partyid7) & 
             !is.na(partner_polictial_belief_2) & 
             #!is.na(currently_living_with_partner) &
             #!is.na(date_relationship_began_month))
             !is.na(grow_up_same_town_2) &
             !is.na(met_online_2) &
             !is.na(income_disparity_2) &
             !is.na(same_university_2) &
             !is.na(partner_education_level_2) &
             !is.na(ppeduc) &
             !is.na(age_when_met) &
             !is.na(hcm2017q24_college)) %>%
  
    mutate(partner_polictial_belief = as.numeric(partner_polictial_belief_2) - 1,
           partyid7 = as.numeric(partyid7) - 1,
           political_diff = abs(partyid7 - partner_polictial_belief),
           grow_up_same_town = as.numeric(grow_up_same_town_2) - 1,
           met_online = as.numeric(met_online_2) - 1,
           marriage_end_mar = as.numeric(marriage_end_mar) - 1,
           income_disparity = as.numeric(income_disparity_2) - 1,
           same_university = as.numeric(same_university_2) - 1,
           partner_education_level = as.numeric(partner_education_level_2) - 1,
           ppeduc = as.numeric(ppeduc) - 1,
           edu_diff = abs(partner_education_level - ppeduc),
           age_when_met = as.numeric(age_when_met),
           hcm2017q24_college = as.numeric(hcm2017q24_college) - 1)

data[ ,c("marriage_end_mar", 
         "political_diff", 
         "grow_up_same_town",
         "met_online",
         "income_disparity",
         "same_university",
         "edu_diff",
         "edu_diff",
         "age_when_met",
         "hcm2017q24_college")] %>%
  cor(method = c("pearson", "kendall", "spearman")) %>%
  round(5) %>%
  ggcorrplot(show.diag = T, type = "full", lab = TRUE, lab_size = 2) +
  ggtitle("Correlation Matrix for Divorced Couples")
```

```{r}
data <-
  df_data %>%
    filter(#!is.na(relationship_quality) & 
             !is.na(relationship_end_nonmar) &
             !is.na(partyid7) & 
             !is.na(partner_polictial_belief_2) & 
             #!is.na(currently_living_with_partner) &
             #!is.na(date_relationship_began_month))
             !is.na(grow_up_same_town_2) &
             !is.na(met_online_2) &
             !is.na(income_disparity_2) &
             !is.na(parents_knew_each_other_before_met_2) &
             !is.na(same_university_2) &
             !is.na(partner_education_level_2) &
             !is.na(ppeduc) &
             !is.na(age_when_met) &
             !is.na(hcm2017q24_college)) %>%
  
    mutate(partner_polictial_belief = as.numeric(partner_polictial_belief_2) - 1,
           partyid7 = as.numeric(partyid7) - 1,
           political_diff = abs(partyid7 - partner_polictial_belief),
           grow_up_same_town = as.numeric(grow_up_same_town_2) - 1,
           met_online = as.numeric(met_online_2) - 1,
           relationship_end_nonmar = as.numeric(relationship_end_nonmar) - 1,
           income_disparity = as.numeric(income_disparity_2) - 1,
           parents_knew_each_other_before_met = as.numeric(parents_knew_each_other_before_met_2) - 1,
           same_university = as.numeric(same_university_2) - 1,
           partner_education_level = as.numeric(partner_education_level_2) - 1,
           ppeduc = as.numeric(ppeduc) - 1,
           edu_diff = abs(partner_education_level - ppeduc),
           age_when_met = as.numeric(age_when_met),
           hcm2017q24_college = as.numeric(hcm2017q24_college))

data[ ,c("relationship_end_nonmar", 
         "political_diff", 
         "grow_up_same_town",
         "met_online",
         "income_disparity",
         "parents_knew_each_other_before_met",
         "same_university",
         "edu_diff",
         "age_when_met",
         "hcm2017q24_college")] %>%
  cor(method = c("pearson", "kendall", "spearman")) %>%
  round(5) %>%
  ggcorrplot(show.diag = T, type = "full", lab = TRUE, lab_size = 2) +
  ggtitle("Correlation Matrix for Broken Up Couples")
```






```{r}
df_data %>%
  filter(!is.na(married) & 
           (married == "Yes, I am Married") & 
           !is.na(age_when_met)) %>%
  mutate(age_when_met = as.numeric(age_when_met)) %>%
  summarize(mean(age_when_met))

df_data %>%
  filter(!is.na(married) & 
           (married == "Yes, I am Married") & 
           !is.na(age_when_met)) %>%
  mutate(age_when_met = as.numeric(age_when_met)) %>%
  summarize(mean(age_when_met))
```



```{r}
model_married <-
  glm(
    formula = married ~ relationship_quality + age_when_met,
    data = df_data %>%
      mutate(relationship_quality = as.numeric(relationship_quality),
             age_when_met = as.numeric(age_when_met)) %>%
      filter(
        !is.na(relationship_quality) &
        !is.na(age_when_met) &
        !is.na(married)),
    family = "binomial"
  )

model_married
model_married %>% 
    tidy(
    conf.int = TRUE,
    conf.level = 0.90
  ) %>% mutate(
    mse = mse_val,
    rsquare = rsquare_val
  )

df_pred_married <-
  df_data %>%
    mutate(relationship_quality = as.numeric(relationship_quality),
         age_when_met = as.numeric(age_when_met)) %>%
    add_uncertainties(model_married, interval = "prediction", prefix = "pi", level = pr_level)

tbl_vars(df_pred_married)

df_pred_married %>%
  summarize(pi_value)
```


























